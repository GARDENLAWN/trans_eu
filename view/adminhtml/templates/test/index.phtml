<?php
/** @var \GardenLawn\TransEu\Block\Adminhtml\Test\Index $block */
$formData = $block->getFormValues();
$apiResult = $block->getApiResult();
$manualTokenValue = $block->getConfigValue('trans_eu/general/manual_token');
$testResult = $block->testTokenRetrieval();

$formatExpiration = function($expiresAt) {
    if (!$expiresAt) return '-';
    $timeLeft = $expiresAt - time();
    $dateStr = date('Y-m-d H:i:s', $expiresAt);
    if ($timeLeft > 0) {
        $minutes = floor($timeLeft / 60);
        return "$dateStr <span class='valid'>(Valid for $minutes min)</span>";
    } else {
        return "$dateStr <span class='expired'>(Expired)</span>";
    }
};
?>

<style>
    .trans-eu-test-wrapper {
        font-family: 'Open Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        color: #303030;
    }
    .trans-eu-section {
        background: #fff;
        border: 1px solid #d1d1d1;
        border-radius: 3px;
        margin-bottom: 20px;
        padding: 20px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .trans-eu-section h2 {
        margin-top: 0;
        border-bottom: 1px solid #e3e3e3;
        padding-bottom: 10px;
        margin-bottom: 20px;
        font-weight: 600;
        font-size: 1.6rem;
        color: #eb5202; /* Magento Orange */
    }
    .trans-eu-section h3 {
        font-size: 1.4rem;
        margin-bottom: 15px;
        color: #333;
        border-left: 3px solid #eb5202;
        padding-left: 10px;
    }
    .data-grid th { background: #f5f5f5; font-weight: 600; }
    .valid { color: #28a745; font-weight: bold; }
    .expired { color: #dc3545; font-weight: bold; }

    /* Form Grid */
    .form-grid {
        display: grid;
        grid-template-columns: 1fr; /* Mobile first: 1 column */
        gap: 15px;
    }

    /* Tablet: 2 columns */
    @media (min-width: 768px) {
        .form-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    /* Desktop: 5 columns in one row */
    @media (min-width: 1400px) {
        .form-grid {
            grid-template-columns: repeat(5, 1fr);
        }
    }

    .form-column {
        background: #f9f9f9;
        padding: 15px;
        border-radius: 4px;
        border: 1px solid #eee;
    }
    .field-row {
        margin-bottom: 15px;
    }
    .field-row label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        font-size: 1.2rem;
    }
    .field-row input[type="text"],
    .field-row input[type="date"],
    .field-row select {
        width: 100%;
        padding: 8px;
        border: 1px solid #adadad;
        border-radius: 1px;
        font-size: 1.3rem;
        height: 3.2rem;
        box-sizing: border-box;
    }
    .field-row select[multiple] {
        height: auto;
        min-height: 8rem;
    }
    .field-row input:focus, .field-row select:focus {
        border-color: #eb5202;
        box-shadow: 0 0 3px rgba(235, 82, 2, 0.3);
    }

    /* Buttons */
    .action-primary-custom {
        background-color: #eb5202;
        border-color: #eb5202;
        color: #fff;
        padding: 10px 20px;
        font-size: 1.4rem;
        font-weight: 600;
        border-radius: 3px;
        cursor: pointer;
        transition: background 0.2s;
        border: 1px solid transparent;
    }
    .action-primary-custom:hover {
        background-color: #ba4000;
        border-color: #ba4000;
        color: #fff;
        text-decoration: none;
    }

    /* Results */
    .result-box {
        background: #f4f8fa;
        border: 1px solid #c3dbe7;
        padding: 15px;
        border-radius: 4px;
        margin-top: 20px;
    }
    .result-success {
        border-left: 5px solid #28a745;
    }
    .result-error {
        border-left: 5px solid #dc3545;
        background: #fff5f5;
        border-color: #f5c6cb;
    }
    pre {
        background: #fff;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 3px;
        overflow-x: auto;
        font-family: Consolas, Monaco, 'Andale Mono', monospace;
        font-size: 1.2rem;
    }

    /* Token Manager */
    .token-manager-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }
    @media (max-width: 1024px) {
        .token-manager-grid { grid-template-columns: 1fr; }
    }
</style>

<div class="page-main-actions">
    <div class="page-actions-placeholder"></div>
    <div class="page-actions" data-ui-id="page-actions-toolbar-content-header">
        <div class="page-actions-inner" data-title="Trans.eu API Test">
            <div class="page-actions-buttons">
                <button id="refresh_test" title="Refresh Page" type="button" class="action-default scalable" onclick="location.href=location.href;">
                    <span>Refresh Page</span>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="trans-eu-test-wrapper">

    <!-- Token Management -->
    <div class="trans-eu-section">
        <h2>Token Management (Browser Session)</h2>

        <div class="message message-warning warning" style="margin-bottom: 15px;">
            <div>
                <strong>Experimental:</strong> Attempting to load Trans.eu login page. <br>
                If the iframe below is empty (blocked by X-Frame-Options), please open <a href="https://auth.platform.trans.eu/accounts/login" target="_blank">Trans.eu Login</a> in a new tab, log in, open Developer Tools (F12) -> Network, find a request, copy the Bearer token, and paste it below.
            </div>
        </div>

        <div class="token-manager-grid">
            <div>
                <h3>1. Login (Iframe)</h3>
                <iframe src="https://auth.platform.trans.eu/accounts/login" style="width: 100%; height: 400px; border: 1px solid #ccc; background: #f9f9f9;"></iframe>
            </div>
            <div>
                <h3>2. Save Token</h3>
                <textarea id="manual_token_input" class="admin__control-textarea" style="width: 100%; height: 350px; font-family: monospace; font-size: 1.1rem;" placeholder="Paste Bearer token here (eyJ...)"><?= $block->escapeHtml($manualTokenValue) ?></textarea>
                <div style="margin-top: 10px; text-align: right;">
                    <span id="save_status" style="margin-right: 10px; font-weight: bold;"></span>
                    <button type="button" class="action-primary-custom" id="save_token_btn">
                        <span>Save Token</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration & Status -->
    <div class="trans-eu-section">
        <h2>Configuration & Status</h2>

        <div class="token-manager-grid"> <!-- Reusing 2-col grid for config/status -->
            <div class="form-column" style="background: #fff; border: none; padding: 0;">
                <h3>Configuration Check</h3>
                <table class="data-grid">
                    <thead><tr><th class="data-grid-th">Setting</th><th class="data-grid-th">Status</th><th class="data-grid-th">Value (Masked)</th></tr></thead>
                    <tbody>
                        <?php foreach ($block->getConfigData() as $path => $label): ?>
                            <?php
                                $value = $block->getConfigValue($path);
                                $statusClass = !empty($value) ? 'grid-severity-notice' : 'grid-severity-critical';
                                $statusLabel = !empty($value) ? 'OK' : 'MISSING';
                                $displayValue = '-';
                                if (!empty($value)) {
                                    if (strpos($path, 'secret') !== false || strpos($path, 'api_key') !== false) {
                                        $displayValue = '********' . substr($value, -4);
                                    } elseif (strlen($value) > 20) {
                                        $displayValue = substr($value, 0, 10) . '...' . substr($value, -5);
                                    } else {
                                        $displayValue = $value;
                                    }
                                }
                            ?>
                            <tr><td><?= $block->escapeHtml($label) ?></td><td><span class="<?= $statusClass ?>"><span><?= $statusLabel ?></span></span></td><td><?= $block->escapeHtml($displayValue) ?></td></tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>

            <div class="form-column" style="background: #fff; border: none; padding: 0;">
                <h3>Stored Tokens</h3>
                <?php
                    $tokens = $block->getTokenInfo();
                    $accessToken = $tokens['access_token'];
                    $refreshToken = $tokens['refresh_token'];
                    $expiresAt = $tokens['expires_at'];
                    $manualToken = $block->getConfigValue('trans_eu/general/manual_token');
                ?>
                <table class="data-grid">
                    <thead><tr><th class="data-grid-th">Token Type</th><th class="data-grid-th">Status</th><th class="data-grid-th">Expires</th></tr></thead>
                    <tbody>
                        <tr>
                            <td><strong>Manual Token</strong> (Priority)</td>
                            <td><span class="<?= !empty($manualToken) ? 'grid-severity-notice' : 'grid-severity-major' ?>"><span><?= !empty($manualToken) ? 'Present' : 'Not Set' ?></span></span></td>
                            <td><?php $exp = $block->getManualTokenExpiration($manualToken); echo $formatExpiration($exp); ?></td>
                        </tr>
                        <tr>
                            <td>OAuth2 Access Token</td>
                            <td><span class="<?= !empty($accessToken) ? 'grid-severity-notice' : 'grid-severity-critical' ?>"><span><?= !empty($accessToken) ? 'Present' : 'Missing' ?></span></span></td>
                            <td><?= $formatExpiration($expiresAt) ?></td>
                        </tr>
                    </tbody>
                </table>

                <div style="margin-top: 20px; padding: 10px; background: #f0f0f0; border-radius: 4px;">
                    <strong>Live Token Check:</strong>
                    <?php if ($testResult['success']): ?>
                        <span class="valid">SUCCESS</span> (<?= $testResult['duration'] ?>s)
                        <?php if ($testResult['token'] !== $accessToken && !empty($accessToken) && empty($manualToken)): ?>
                            <br><small>Note: Token was automatically refreshed.</small>
                        <?php endif; ?>
                    <?php else: ?>
                        <span class="expired">FAILED</span> <br><small><?= $block->escapeHtml($testResult['message']) ?></small>
                    <?php endif; ?>
                </div>
            </div>
        </div>
    </div>

    <!-- API Endpoint Test Form -->
    <?php if ($testResult['success']): ?>
    <div class="trans-eu-section">
        <h2>API Endpoint Test (Price Prediction)</h2>

        <form id="api_test_form">
            <div class="form-grid">

                <!-- General Info -->
                <div class="form-column">
                    <h3>General Info</h3>
                    <div class="field-row">
                        <label>Company ID</label>
                        <input type="text" name="company_id" value="<?= $block->escapeHtmlAttr($formData['company_id']) ?>" />
                    </div>
                    <div class="field-row">
                        <label>User ID</label>
                        <input type="text" name="user_id" value="<?= $block->escapeHtmlAttr($formData['user_id']) ?>" />
                    </div>
                    <div class="field-row">
                        <label>Distance (m)</label>
                        <input type="text" name="distance" value="<?= $block->escapeHtmlAttr($formData['distance']) ?>" />
                    </div>
                    <div class="field-row">
                        <label>Total Length (m)</label>
                        <input type="text" name="total_length" value="<?= $block->escapeHtmlAttr($formData['total_length']) ?>" />
                    </div>
                </div>

                <!-- Vehicle -->
                <div class="form-column">
                    <h3>Vehicle Requirements</h3>
                    <div class="field-row">
                        <label>Body (Multiselect)</label>
                        <select name="vehicle_body[]" multiple size="5">
                            <?php
                                $selectedBodies = is_array($formData['vehicle_body']) ? $formData['vehicle_body'] : explode(',', $formData['vehicle_body']);
                            ?>
                            <?php foreach ($block->getVehicleBodyOptions() as $option): ?>
                                <option value="<?= $option['value'] ?>" <?= in_array($option['value'], $selectedBodies) ? 'selected' : '' ?>><?= $option['label'] ?></option>
                            <?php endforeach; ?>
                        </select>
                        <small>Hold Ctrl/Cmd to select multiple</small>
                    </div>
                    <div class="field-row">
                        <label>Size ID (Multiselect)</label>
                        <select name="vehicle_size[]" multiple size="5">
                            <?php
                                $selectedSizes = is_array($formData['vehicle_size']) ? $formData['vehicle_size'] : explode(',', $formData['vehicle_size']);
                            ?>
                            <?php foreach ($block->getVehicleSizeOptions() as $option): ?>
                                <option value="<?= $option['value'] ?>" <?= in_array($option['value'], $selectedSizes) ? 'selected' : '' ?>><?= $option['label'] ?></option>
                            <?php endforeach; ?>
                        </select>
                        <small>Hold Ctrl/Cmd to select multiple</small>
                    </div>
                    <div class="field-row">
                        <label>Freight Type</label>
                        <select name="freight_type">
                            <?php foreach ($block->getFreightTypeOptions() as $option): ?>
                                <option value="<?= $option['value'] ?>" <?= $formData['freight_type'] == $option['value'] ? 'selected' : '' ?>><?= $option['label'] ?></option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    <div class="field-row">
                        <label>Capacity (Tons)</label>
                        <input type="text" name="capacity" id="capacity_input" value="<?= $block->escapeHtmlAttr($formData['capacity']) ?>" />
                    </div>
                </div>

                <!-- Load Details -->
                <div class="form-column">
                    <h3>Load Details</h3>
                    <div class="field-row">
                        <label>Quantity (mÂ²)</label>
                        <input type="text" name="qty_m2" id="qty_m2_input" value="<?= $block->escapeHtmlAttr($formData['qty_m2']) ?>" style="border-color: #007bdb;" />
                        <small>Changing this updates Amount & Capacity</small>
                    </div>
                    <div class="field-row">
                        <label>Name</label>
                        <input type="text" name="load_name" value="<?= $block->escapeHtmlAttr($formData['load_name']) ?>" />
                    </div>
                    <div class="field-row">
                        <label>Type</label>
                        <select name="load_type">
                            <?php foreach ($block->getLoadTypeOptions() as $option): ?>
                                <option value="<?= $option['value'] ?>" <?= $formData['load_type'] == $option['value'] ? 'selected' : '' ?>><?= $option['label'] ?></option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    <div class="field-row">
                        <label>Amount (Pallets)</label>
                        <input type="text" name="load_amount" id="load_amount_input" value="<?= $block->escapeHtmlAttr($formData['load_amount']) ?>" />
                    </div>
                    <div class="field-row">
                        <label>Length (m)</label>
                        <input type="text" name="load_length" value="<?= $block->escapeHtmlAttr($formData['load_length']) ?>" />
                    </div>
                    <div class="field-row">
                        <label>Width (m)</label>
                        <input type="text" name="load_width" value="<?= $block->escapeHtmlAttr($formData['load_width']) ?>" />
                    </div>
                </div>

                <!-- Source -->
                <div class="form-column">
                    <h3>Loading (Source)</h3>
                    <div class="field-row">
                        <label>City</label>
                        <input type="text" name="source_city" value="<?= $block->escapeHtmlAttr($formData['source_city']) ?>" />
                    </div>
                    <div class="field-row">
                        <label>Zip Code</label>
                        <input type="text" name="source_zip" value="<?= $block->escapeHtmlAttr($formData['source_zip']) ?>" />
                    </div>
                    <div class="field-row">
                        <label>Latitude</label>
                        <input type="text" name="source_lat" value="<?= $block->escapeHtmlAttr($formData['source_lat']) ?>" />
                    </div>
                    <div class="field-row">
                        <label>Longitude</label>
                        <input type="text" name="source_lon" value="<?= $block->escapeHtmlAttr($formData['source_lon']) ?>" />
                    </div>
                    <div class="field-row">
                        <label>Date</label>
                        <input type="date" name="source_date" value="<?= $block->escapeHtmlAttr($formData['source_date']) ?>" />
                    </div>
                </div>

                <!-- Destination -->
                <div class="form-column">
                    <h3>Unloading (Destination)</h3>
                    <div class="field-row">
                        <label>City</label>
                        <input type="text" name="dest_city" value="<?= $block->escapeHtmlAttr($formData['dest_city']) ?>" />
                    </div>
                    <div class="field-row">
                        <label>Zip Code</label>
                        <input type="text" name="dest_zip" value="<?= $block->escapeHtmlAttr($formData['dest_zip']) ?>" />
                    </div>
                    <div class="field-row">
                        <label>Latitude</label>
                        <input type="text" name="dest_lat" value="<?= $block->escapeHtmlAttr($formData['dest_lat']) ?>" />
                    </div>
                    <div class="field-row">
                        <label>Longitude</label>
                        <input type="text" name="dest_lon" value="<?= $block->escapeHtmlAttr($formData['dest_lon']) ?>" />
                    </div>
                    <div class="field-row">
                        <label>Date</label>
                        <input type="date" name="dest_date" value="<?= $block->escapeHtmlAttr($formData['dest_date']) ?>" />
                    </div>
                </div>

            </div>

            <div style="margin-top: 20px; text-align: right;">
                <span id="api_status_msg" style="margin-right: 15px; font-weight: bold; font-size: 1.2rem;"></span>
                <button type="button" class="action-primary-custom" id="predict_price_btn" style="font-size: 1.6rem; padding: 12px 30px;">
                    <span>Get Price Prediction</span>
                </button>
            </div>
        </form>

        <div id="api_result_container" style="display: none;">
            <div class="result-box result-success">
                <h4 style="margin-top: 0; color: #28a745;">Response</h4>
                <pre id="api_result_pre"></pre>
            </div>

            <div style="margin-top: 20px;">
                <strong>Generated Payload (Debug):</strong>
                <pre id="api_payload_pre" style="background: #f9f9f9; font-size: 11px; color: #666;"></pre>
            </div>
        </div>

    </div>

    <!-- API Endpoint Test: Freights List -->
    <div class="trans-eu-section">
        <h2>API Endpoint Test (Freights List)</h2>

        <form action="<?= $block->getUrl('*/*/*') ?>" method="post">
            <?= $block->getBlockHtml('formkey') ?>
            <input type="hidden" name="action" value="freights_list" />
            <div style="text-align: right;">
                <button type="submit" class="action-primary-custom"><span>Get Freights List</span></button>
            </div>
        </form>

        <?php if ($apiResult && isset($apiResult['type']) && $apiResult['type'] == 'freights_list'): ?>
            <div class="result-box <?= $apiResult['success'] ? 'result-success' : 'result-error' ?>" style="margin-top: 20px;">
                <h4 style="margin-top: 0;">Result (Status <?= $apiResult['status'] ?? 'Unknown' ?>)</h4>
                <?php if ($apiResult['success']): ?>
                    <pre style="max-height: 500px; overflow-y: auto;"><?= json_encode($apiResult['response'], JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE) ?></pre>
                <?php else: ?>
                    <div style="color: #dc3545; font-weight: bold;"><?= $block->escapeHtml($apiResult['message']) ?></div>
                <?php endif; ?>
            </div>
        <?php endif; ?>
    </div>

    <?php endif; ?>
</div>

<script>
    require(['jquery'], function($) {
        // Save Token Logic
        $('#save_token_btn').click(function() {
            var token = $('#manual_token_input').val();
            if (!token) {
                alert('Please paste a token first.');
                return;
            }
            var statusSpan = $('#save_status');
            statusSpan.css('color', 'blue').text('Saving...');
            $.ajax({
                url: '<?= $block->getUrl('gardenlawn_transeu/test/saveToken') ?>',
                type: 'POST',
                data: { token: token, form_key: FORM_KEY },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        statusSpan.css('color', 'green').text('Saved! Reloading...');
                        setTimeout(function() { location.reload(); }, 1000);
                    } else {
                        statusSpan.css('color', 'red').text('Error: ' + response.message);
                    }
                },
                error: function() { statusSpan.css('color', 'red').text('Connection error.'); }
            });
        });

        // Auto-calculate capacity and amount based on m2
        $('#qty_m2_input').on('input', function() {
            var m2 = parseFloat($(this).val());
            if (!isNaN(m2) && m2 > 0) {
                // 1 pallet = 50 m2
                var pallets = Math.ceil(m2 / 50);
                $('#load_amount_input').val(pallets);

                // 1 m2 = 25 kg => tons
                var weightKg = m2 * 25;
                var weightTons = Math.ceil(weightKg / 1000);
                if (weightTons < 1) weightTons = 1;
                $('#capacity_input').val(weightTons);
            }
        });

        // Price Prediction Logic
        $('#predict_price_btn').click(function() {
            var form = $('#api_test_form');
            var resultContainer = $('#api_result_container');
            var resultPre = $('#api_result_pre');
            var payloadPre = $('#api_payload_pre');
            var statusMsg = $('#api_status_msg');
            var manualToken = $('#manual_token_input').val();
            var data = form.serialize();
            if (manualToken) { data += '&token=' + encodeURIComponent(manualToken); }

            resultContainer.hide();
            statusMsg.html('<span style="color: blue;">Sending request...</span>');

            $.ajax({
                url: '<?= $block->getUrl('gardenlawn_transeu/test/predictPrice') ?>',
                type: 'POST',
                data: data + '&form_key=' + FORM_KEY,
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        statusMsg.html('<span style="color: green;">SUCCESS</span>');
                        resultPre.text(JSON.stringify(response.response, null, 4));
                        resultContainer.find('.result-box').removeClass('result-error').addClass('result-success');
                    } else {
                        statusMsg.html('<span style="color: red;">FAILED: ' + response.message + '</span>');
                        resultPre.text('');
                        resultContainer.find('.result-box').removeClass('result-success').addClass('result-error');
                    }
                    if (response.request_payload) {
                        payloadPre.text(JSON.stringify(response.request_payload, null, 4));
                    }
                    resultContainer.slideDown();
                },
                error: function() { statusMsg.html('<span style="color: red;">Connection Error</span>'); }
            });
        });
    });
</script>
