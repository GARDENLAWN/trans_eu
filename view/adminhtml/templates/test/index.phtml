<?php
/** @var \GardenLawn\TransEu\Block\Adminhtml\Test\Index $block */
$formData = $block->getFormValues();
$apiResult = $block->getApiResult();
$manualTokenValue = $block->getConfigValue('trans_eu/general/manual_token');
$testResult = $block->testTokenRetrieval();

$formatExpiration = function($expiresAt) {
    if (!$expiresAt) return '-';
    $timeLeft = $expiresAt - time();
    $dateStr = date('Y-m-d H:i:s', $expiresAt);
    if ($timeLeft > 0) {
        $minutes = floor($timeLeft / 60);
        return "$dateStr <span class='valid'>(Valid for $minutes min)</span>";
    } else {
        return "$dateStr <span class='expired'>(Expired)</span>";
    }
};

// Get current time in Poland for defaults
$now = new \DateTime('now', new \DateTimeZone('Europe/Warsaw'));
$defaultDate = $now->format('Y-m-d');
$defaultTime = $now->format('H:i');
?>

<style>
    .trans-eu-test-wrapper {
        font-family: 'Open Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        color: #303030;
    }
    .trans-eu-section {
        background: #fff;
        border: 1px solid #d1d1d1;
        border-radius: 3px;
        margin-bottom: 20px;
        padding: 20px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .trans-eu-section h2 {
        margin-top: 0;
        border-bottom: 1px solid #e3e3e3;
        padding-bottom: 10px;
        margin-bottom: 20px;
        font-weight: 600;
        font-size: 1.6rem;
        color: #eb5202; /* Magento Orange */
    }
    .trans-eu-section h3 {
        font-size: 1.4rem;
        margin-bottom: 15px;
        color: #333;
        border-left: 3px solid #eb5202;
        padding-left: 10px;
    }
    .data-grid th { background: #f5f5f5; font-weight: 600; }
    .valid { color: #28a745; font-weight: bold; }
    .expired { color: #dc3545; font-weight: bold; }

    /* Form Grid */
    .form-grid {
        display: grid;
        grid-template-columns: 1fr; /* Mobile first: 1 column */
        gap: 15px;
    }

    /* Tablet: 2 columns */
    @media (min-width: 768px) {
        .form-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    /* Desktop: 5 columns in one row */
    @media (min-width: 1400px) {
        .form-grid {
            grid-template-columns: repeat(5, 1fr);
        }
    }

    .form-column {
        background: #f9f9f9;
        padding: 15px;
        border-radius: 4px;
        border: 1px solid #eee;
    }
    .field-row {
        margin-bottom: 15px;
    }
    .field-row label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        font-size: 1.2rem;
    }
    .field-row input[type="text"],
    .field-row input[type="date"],
    .field-row input[type="time"],
    .field-row select {
        width: 100%;
        padding: 8px;
        border: 1px solid #adadad;
        border-radius: 1px;
        font-size: 1.3rem;
        height: 3.2rem;
        box-sizing: border-box;
    }
    .field-row select[multiple] {
        height: auto;
        min-height: 8rem;
    }
    .field-row input:focus, .field-row select:focus {
        border-color: #eb5202;
        box-shadow: 0 0 3px rgba(235, 82, 2, 0.3);
    }
    .field-row input[readonly] {
        background-color: #e9ecef;
        color: #495057;
        cursor: not-allowed;
    }

    /* Buttons */
    .action-primary-custom {
        background-color: #eb5202;
        border-color: #eb5202;
        color: #fff;
        padding: 10px 20px;
        font-size: 1.4rem;
        font-weight: 600;
        border-radius: 3px;
        cursor: pointer;
        transition: background 0.2s;
        border: 1px solid transparent;
    }
    .action-primary-custom:hover {
        background-color: #ba4000;
        border-color: #ba4000;
        color: #fff;
        text-decoration: none;
    }
    .action-secondary-custom {
        background-color: #f0f0f0;
        border-color: #ccc;
        color: #333;
        padding: 8px 15px;
        font-size: 1.3rem;
        font-weight: 600;
        border-radius: 3px;
        cursor: pointer;
        border: 1px solid #ccc;
    }
    .action-secondary-custom:hover {
        background-color: #e0e0e0;
    }

    /* Results */
    .result-box {
        background: #f4f8fa;
        border: 1px solid #c3dbe7;
        padding: 15px;
        border-radius: 4px;
        margin-top: 20px;
    }
    .result-success {
        border-left: 5px solid #28a745;
    }
    .result-error {
        border-left: 5px solid #dc3545;
        background: #fff5f5;
        border-color: #f5c6cb;
    }
    pre {
        background: #fff;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 3px;
        overflow-x: auto;
        font-family: Consolas, Monaco, 'Andale Mono', monospace;
        font-size: 1.2rem;
    }

    /* Debug Info Styles */
    .debug-section { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .debug-section:last-child { border-bottom: none; }
    .debug-title { font-weight: bold; color: #555; margin-bottom: 5px; display: block; font-size: 1.1em; }
    .debug-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
    .debug-table td { padding: 4px 8px; border: 1px solid #ddd; }
    .debug-table td:first-child { font-weight: 600; background: #f9f9f9; width: 30%; }
    .debug-steps { list-style: none; padding: 0; margin: 0; }
    .debug-steps li { padding: 3px 0; border-bottom: 1px dashed #eee; }
    .debug-steps li:last-child { border-bottom: none; }
    .json-toggle { cursor: pointer; color: #007bdb; text-decoration: underline; font-size: 0.9em; }
    .json-content { display: none; margin-top: 5px; }

    /* Token Manager */
    .token-manager-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }
    @media (max-width: 1024px) {
        .token-manager-grid { grid-template-columns: 1fr; }
    }
</style>

<div class="page-main-actions">
    <div class="page-actions-placeholder"></div>
    <div class="page-actions" data-ui-id="page-actions-toolbar-content-header">
        <div class="page-actions-inner" data-title="Trans.eu API Test">
            <div class="page-actions-buttons">
                <button id="refresh_test" title="Refresh Page" type="button" class="action-default scalable" onclick="location.href=location.href;">
                    <span>Refresh Page</span>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="trans-eu-test-wrapper">

    <!-- Token Management -->
    <div class="trans-eu-section">
        <h2>Token Management</h2>

        <div class="message message-notice notice" style="margin-bottom: 15px;">
            <div>
                <strong>Auto-Login:</strong> Uses Python/Selenium script to fetch token from Trans.eu. Requires server-side setup (Chrome/Firefox).<br>
                <strong>Manual:</strong> Paste token from browser Developer Tools if auto-login fails.
            </div>
        </div>

        <div>
            <h3>Current Token</h3>
            <textarea id="manual_token_input" class="admin__control-textarea" style="width: 100%; height: 150px; font-family: monospace; font-size: 1.1rem;" placeholder="Paste Bearer token here (eyJ...)"><?= $block->escapeHtml($manualTokenValue) ?></textarea>
            <div style="margin-top: 10px; text-align: right;">
                <span id="save_status" style="margin-right: 10px; font-weight: bold;"></span>
                <button type="button" class="action-default scalable" id="auto_login_btn" style="margin-right: 10px;">
                    <span>Auto-Login (Python)</span>
                </button>
                <button type="button" class="action-primary-custom" id="save_token_btn">
                    <span>Save Token</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Configuration & Status -->
    <div class="trans-eu-section">
        <h2>Configuration & Status</h2>

        <div class="token-manager-grid"> <!-- Reusing 2-col grid for config/status -->
            <div class="form-column" style="background: #fff; border: none; padding: 0;">
                <h3>Configuration Check</h3>
                <table class="data-grid">
                    <thead><tr><th class="data-grid-th">Setting</th><th class="data-grid-th">Status</th><th class="data-grid-th">Value (Masked)</th></tr></thead>
                    <tbody>
                        <?php foreach ($block->getConfigData() as $path => $label): ?>
                            <?php
                                $value = $block->getConfigValue($path);
                                $statusClass = !empty($value) ? 'grid-severity-notice' : 'grid-severity-critical';
                                $statusLabel = !empty($value) ? 'OK' : 'MISSING';
                                $displayValue = '-';
                                if (!empty($value)) {
                                    if (strpos($path, 'secret') !== false || strpos($path, 'api_key') !== false) {
                                        $displayValue = '********' . substr($value, -4);
                                    } elseif (strlen($value) > 20) {
                                        $displayValue = substr($value, 0, 10) . '...' . substr($value, -5);
                                    } else {
                                        $displayValue = $value;
                                    }
                                }
                            ?>
                            <tr><td><?= $block->escapeHtml($label) ?></td><td><small><?= $block->escapeHtml($path) ?></small></td><td><span class="<?= $statusClass ?>"><span><?= $statusLabel ?></span></span></td><td><?= $block->escapeHtml($displayValue) ?></td></tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>

            <div class="form-column" style="background: #fff; border: none; padding: 0;">
                <h3>Stored Tokens</h3>
                <?php
                    $tokens = $block->getTokenInfo();
                    $accessToken = $tokens['access_token'];
                    $refreshToken = $tokens['refresh_token'];
                    $expiresAt = $tokens['expires_at'];
                    $manualToken = $block->getConfigValue('trans_eu/general/manual_token');
                ?>
                <table class="data-grid">
                    <thead><tr><th class="data-grid-th">Token Type</th><th class="data-grid-th">Status</th><th class="data-grid-th">Expires</th></tr></thead>
                    <tbody>
                        <tr>
                            <td><strong>Manual Token</strong> (Priority)</td>
                            <td><span class="<?= !empty($manualToken) ? 'grid-severity-notice' : 'grid-severity-major' ?>"><span><?= !empty($manualToken) ? 'Present' : 'Not Set' ?></span></span></td>
                            <td><?php $exp = $block->getManualTokenExpiration($manualToken); echo $formatExpiration($exp); ?></td>
                        </tr>
                        <tr>
                            <td>OAuth2 Access Token</td>
                            <td><span class="<?= !empty($accessToken) ? 'grid-severity-notice' : 'grid-severity-critical' ?>"><span><?= !empty($accessToken) ? 'Present' : 'Missing' ?></span></span></td>
                            <td><?= $formatExpiration($expiresAt) ?></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- API Endpoint Test Form (Full Flow) -->
    <div class="trans-eu-section">
        <h2>API Endpoint Test (Full Flow)</h2>
        <p>Select a carrier and quantity to auto-fill parameters from rules, then send request.</p>

        <div style="background: #e6f7ff; padding: 15px; border: 1px solid #b8e0f5; border-radius: 4px; margin-bottom: 20px;">
            <div class="form-grid">
                <div class="field-row">
                    <label>Carrier Method</label>
                    <select id="sim_carrier_code">
                        <option value="direct_no_lift">Direct No Lift</option>
                        <option value="direct_lift">Direct Lift</option>
                        <option value="direct_forklift">Direct Forklift</option>
                    </select>
                </div>
                <div class="field-row">
                    <label>Quantity (m²)</label>
                    <input type="text" id="sim_qty_m2" value="100" />
                </div>
                <div class="field-row" style="display: flex; align-items: flex-end;">
                    <button type="button" class="action-secondary-custom" id="load_config_btn" style="width: 100%;">
                        <span>Load Config from Rules</span>
                    </button>
                </div>
            </div>
            <div id="rule_match_info" style="margin-top: 10px; font-weight: bold; color: #0056b3;"></div>
        </div>

        <form id="api_test_form">
            <div class="form-grid">

                <!-- General Info -->
                <div class="form-column">
                    <h3>General Info</h3>
                    <div class="field-row">
                        <label>Company ID</label>
                        <input type="text" name="company_id" value="<?= $block->escapeHtmlAttr($formData['company_id']) ?>" />
                    </div>
                    <div class="field-row">
                        <label>User ID</label>
                        <input type="text" name="user_id" value="<?= $block->escapeHtmlAttr($formData['user_id']) ?>" />
                    </div>
                    <div class="field-row">
                        <label>Distance (m)</label>
                        <input type="text" name="distance" value="<?= $block->escapeHtmlAttr($formData['distance']) ?>" />
                    </div>
                    <div class="field-row">
                        <label>Total Length (m)</label>
                        <input type="text" name="total_length" id="total_length_input" value="<?= $block->escapeHtmlAttr($formData['total_length']) ?>" />
                    </div>
                </div>

                <!-- Vehicle -->
                <div class="form-column">
                    <h3>Vehicle Requirements</h3>
                    <div class="field-row">
                        <label>Body (Multiselect)</label>
                        <select name="vehicle_body[]" id="vehicle_body_select" multiple size="5">
                            <?php
                                $selectedBodies = is_array($formData['vehicle_body']) ? $formData['vehicle_body'] : explode(',', $formData['vehicle_body']);
                            ?>
                            <?php foreach ($block->getVehicleBodyOptions() as $option): ?>
                                <option value="<?= $option['value'] ?>" <?= in_array($option['value'], $selectedBodies) ? 'selected' : '' ?>><?= $option['label'] ?></option>
                            <?php endforeach; ?>
                        </select>
                        <small>Hold Ctrl/Cmd to select multiple</small>
                    </div>
                    <div class="field-row">
                        <label>Size ID (Multiselect)</label>
                        <select name="vehicle_size[]" id="vehicle_size_select" multiple size="5">
                            <?php
                                $selectedSizes = is_array($formData['vehicle_size']) ? $formData['vehicle_size'] : explode(',', $formData['vehicle_size']);
                            ?>
                            <?php foreach ($block->getVehicleSizeOptions() as $option): ?>
                                <option value="<?= $option['value'] ?>" <?= in_array($option['value'], $selectedSizes) ? 'selected' : '' ?>><?= $option['label'] ?></option>
                            <?php endforeach; ?>
                        </select>
                        <small>Hold Ctrl/Cmd to select multiple</small>
                    </div>
                    <div class="field-row">
                        <label>Freight Type</label>
                        <select name="freight_type" id="freight_type_select">
                            <?php foreach ($block->getFreightTypeOptions() as $option): ?>
                                <option value="<?= $option['value'] ?>" <?= $formData['freight_type'] == $option['value'] ? 'selected' : '' ?>><?= $option['label'] ?></option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    <div class="field-row">
                        <label>Capacity (Tons)</label>
                        <input type="text" name="capacity" id="capacity_input" value="<?= $block->escapeHtmlAttr($formData['capacity']) ?>" readonly />
                        <small>Auto-calculated from m²</small>
                    </div>
                    <div class="field-row">
                        <label>Other Requirements</label>
                        <select name="other_requirements[]" id="other_req_select" multiple size="5">
                            <?php
                                $selectedOther = is_array($formData['other_requirements']) ? $formData['other_requirements'] : [];
                            ?>
                            <?php foreach ($block->getOtherRequirementsOptions() as $option): ?>
                                <option value="<?= $option['value'] ?>" <?= in_array($option['value'], $selectedOther) ? 'selected' : '' ?>><?= $option['label'] ?></option>
                            <?php endforeach; ?>
                        </select>
                        <small>Hold Ctrl/Cmd to select multiple</small>
                    </div>
                </div>

                <!-- Load Details -->
                <div class="form-column">
                    <h3>Load Details</h3>
                    <div class="field-row">
                        <label>Quantity (m²)</label>
                        <input type="text" name="qty_m2" id="qty_m2_input" value="<?= $block->escapeHtmlAttr($formData['qty_m2']) ?>" style="border-color: #007bdb;" />
                        <small>Changing this updates Amount & Capacity</small>
                    </div>
                    <div class="field-row">
                        <label>Name</label>
                        <input type="text" name="load_name" value="<?= $block->escapeHtmlAttr($formData['load_name']) ?>" />
                    </div>
                    <div class="field-row">
                        <label>Type</label>
                        <select name="load_type" id="load_type_select">
                            <?php foreach ($block->getLoadTypeOptions() as $option): ?>
                                <option value="<?= $option['value'] ?>" <?= $formData['load_type'] == $option['value'] ? 'selected' : '' ?>><?= $option['label'] ?></option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    <div class="field-row">
                        <label>Amount (Pallets)</label>
                        <input type="text" name="load_amount" id="load_amount_input" value="<?= $block->escapeHtmlAttr($formData['load_amount']) ?>" readonly />
                        <small>Auto-calculated from m²</small>
                    </div>
                </div>

                <!-- Source -->
                <div class="form-column">
                    <h3>Loading (Source)</h3>
                    <div class="field-row">
                        <label>City</label>
                        <input type="text" name="source_city" value="<?= $block->escapeHtmlAttr($formData['source_city']) ?>" />
                    </div>
                    <div class="field-row">
                        <label>Zip Code</label>
                        <input type="text" name="source_zip" value="<?= $block->escapeHtmlAttr($formData['source_zip']) ?>" />
                    </div>
                    <div class="field-row">
                        <label>Latitude</label>
                        <input type="text" name="source_lat" value="<?= $block->escapeHtmlAttr($formData['source_lat']) ?>" />
                    </div>
                    <div class="field-row">
                        <label>Longitude</label>
                        <input type="text" name="source_lon" value="<?= $block->escapeHtmlAttr($formData['source_lon']) ?>" />
                    </div>
                    <div class="field-row">
                        <label>Date</label>
                        <input type="date" name="source_date" value="<?= $block->escapeHtmlAttr($formData['source_date'] ?? $defaultDate) ?>" />
                    </div>
                    <div class="field-row">
                        <label>Time</label>
                        <input type="time" name="source_time" value="<?= $block->escapeHtmlAttr(($formData['source_time'] ?? '') ?: $defaultTime) ?>" />
                    </div>
                </div>

                <!-- Destination -->
                <div class="form-column">
                    <h3>Unloading (Destination)</h3>
                    <div class="field-row">
                        <label>City</label>
                        <input type="text" name="dest_city" value="<?= $block->escapeHtmlAttr($formData['dest_city']) ?>" />
                    </div>
                    <div class="field-row">
                        <label>Zip Code</label>
                        <input type="text" name="dest_zip" value="<?= $block->escapeHtmlAttr($formData['dest_zip']) ?>" />
                    </div>
                    <div class="field-row">
                        <label>Latitude</label>
                        <input type="text" name="dest_lat" value="<?= $block->escapeHtmlAttr($formData['dest_lat']) ?>" />
                    </div>
                    <div class="field-row">
                        <label>Longitude</label>
                        <input type="text" name="dest_lon" value="<?= $block->escapeHtmlAttr($formData['dest_lon']) ?>" />
                    </div>
                    <div class="field-row">
                        <label>Date</label>
                        <input type="date" name="dest_date" value="<?= $block->escapeHtmlAttr($formData['dest_date'] ?? $defaultDate) ?>" />
                    </div>
                    <div class="field-row">
                        <label>Time</label>
                        <input type="time" name="dest_time" value="<?= $block->escapeHtmlAttr(($formData['dest_time'] ?? '') ?: $defaultTime) ?>" />
                    </div>
                </div>

            </div>

            <div style="margin-top: 20px; text-align: right;">
                <span id="api_status_msg" style="margin-right: 15px; font-weight: bold; font-size: 1.2rem;"></span>
                <button type="button" class="action-primary-custom" id="predict_price_btn" style="font-size: 1.6rem; padding: 12px 30px;">
                    <span>Get Price Prediction</span>
                </button>
            </div>
        </form>

        <div id="api_result_container" style="display: none;">
            <div class="result-box result-success">
                <h4 style="margin-top: 0; color: #28a745;">Response</h4>
                <div id="api_result_content"></div>
            </div>
        </div>

    </div>

    <!-- API Endpoint Test (Freights List) -->
    <div class="trans-eu-section">
        <h2>API Endpoint Test (Freights List)</h2>

        <form id="freights_list_form">
            <div style="text-align: right;">
                <button type="button" class="action-primary-custom" id="get_freights_btn"><span>Get Freights List</span></button>
            </div>
        </form>

        <div id="freights_result_container" style="display: none; margin-top: 20px;">
            <div class="result-box result-success">
                <h4 style="margin-top: 0;">Result</h4>
                <pre id="freights_result_pre" style="max-height: 500px; overflow-y: auto;"></pre>
            </div>
        </div>
    </div>

</div>

<script>
    require(['jquery'], function($) {
        // Save Token Logic
        $('#save_token_btn').click(function() {
            var token = $('#manual_token_input').val();
            if (!token) {
                alert('Please paste a token first.');
                return;
            }
            var statusSpan = $('#save_status');
            statusSpan.css('color', 'blue').text('Saving...');
            $.ajax({
                url: '<?= $block->getUrl('gardenlawn_transeu/test/saveToken') ?>',
                type: 'POST',
                data: { token: token, form_key: FORM_KEY },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        statusSpan.css('color', 'green').text('Saved! Reloading...');
                        setTimeout(function() { location.reload(); }, 1000);
                    } else {
                        statusSpan.css('color', 'red').text('Error: ' + response.message);
                    }
                },
                error: function() { statusSpan.css('color', 'red').text('Connection error.'); }
            });
        });

        // Auto-Login Logic
        $('#auto_login_btn').click(function() {
            var statusSpan = $('#save_status');
            statusSpan.css('color', 'blue').text('Running Python script... (this may take 20s)');

            $.ajax({
                url: '<?= $block->getUrl('gardenlawn_transeu/test/autoLogin') ?>',
                type: 'POST',
                data: { form_key: FORM_KEY },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        statusSpan.css('color', 'green').text('Success! Reloading...');
                        setTimeout(function() { location.reload(); }, 1000);
                    } else {
                        statusSpan.css('color', 'red').text('Error: ' + response.message);
                    }
                },
                error: function() { statusSpan.css('color', 'red').text('Connection error.'); }
            });
        });

        // Sync Qty inputs
        $('#sim_qty_m2').on('input', function() {
            $('#qty_m2_input').val($(this).val()).trigger('input');
        });
        $('#qty_m2_input').on('input', function() {
            $('#sim_qty_m2').val($(this).val());

            // Auto-calculate capacity and amount based on m2
            var m2 = parseFloat($(this).val());
            if (!isNaN(m2) && m2 > 0) {
                // 1 pallet = 50 m2 (This is just a rough estimate for UI, real logic is in backend)
                // But wait, backend logic is complex. Let's rely on "Load Config" button for accurate values.
                // For now, simple estimation:
                var pallets = Math.ceil(m2 / 35); // Using 35 as default from config
                $('#load_amount_input').val(pallets);

                // 1 m2 = 25 kg => tons
                var weightKg = m2 * 25;
                var weightTons = Math.ceil(weightKg / 1000);
                if (weightTons < 1) weightTons = 1;
                $('#capacity_input').val(weightTons);
            }
        });

        // Load Config from Rules Logic
        $('#load_config_btn').click(function() {
            var carrier = $('#sim_carrier_code').val();
            var qty = $('#sim_qty_m2').val();
            var infoDiv = $('#rule_match_info');

            infoDiv.text('Loading configuration...');

            $.ajax({
                url: '<?= $block->getUrl('gardenlawn_transeu/test/testQuote') ?>',
                type: 'POST',
                data: { action: 'simulate', carrier_code: carrier, qty_m2: qty, form_key: FORM_KEY },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        var p = response.params;

                        // Fill form fields
                        $('#vehicle_size_select').val(p.vehicle_size_id);
                        $('#vehicle_body_select').val(p.vehicle_bodies);
                        $('#freight_type_select').val(p.freight_type);
                        $('#capacity_input').val(p.capacity_tons);
                        $('#load_amount_input').val(p.load_amount);
                        $('#load_type_select').val(p.load_type);
                        // Removed load_length and load_width inputs
                        $('#total_length_input').val(p.total_ldm);
                        $('#other_req_select').val(p.other_requirements);

                        // Show matched rule info
                        if (response.matched_rule) {
                            infoDiv.html('<span style="color:green">✔ Matched Rule:</span> Max Pallets ' + response.matched_rule.max_pallets);
                        } else {
                            infoDiv.html('<span style="color:orange">⚠ No specific rule matched (Using fallback)</span>');
                        }
                    } else {
                        infoDiv.html('<span style="color:red">Error: ' + response.message + '</span>');
                    }
                },
                error: function() {
                    infoDiv.html('<span style="color:red">Connection Error</span>');
                }
            });
        });

        function formatApiResult(data) {
            var html = '';
            var resp = data.response;
            var payload = data.request_payload;

            // 1. Price Summary
            html += '<div class="debug-section">';
            html += '<span class="debug-title">Price Prediction</span>';
            html += '<table class="debug-table">';

            if (resp.price_details) {
                var pd = resp.price_details;
                html += '<tr><td><strong>Final Price (Netto)</strong></td><td><strong style="color:#28a745; font-size:1.4em;">' + pd.final_net.toFixed(2) + ' PLN</strong></td></tr>';
                html += '<tr><td>Tax Rate</td><td>' + pd.tax_rate + '%</td></tr>';
                html += '<tr><td>Gross Price (Rounded)</td><td>' + pd.gross_rounded + ' PLN</td></tr>';
                html += '<tr><td>Base Price (EUR)</td><td>' + pd.base_eur + ' EUR</td></tr>';
                html += '<tr><td>Exchange Rate</td><td>' + resp.rate_eur_pln + '</td></tr>';
            } else if (resp.prediction_pln) {
                html += '<tr><td><strong>Final Price (Netto)</strong></td><td><strong style="color:#28a745; font-size:1.4em;">' + resp.prediction_pln + ' PLN</strong></td></tr>';
                html += '<tr><td>Base Price (EUR)</td><td>' + (resp.prediction ? resp.prediction[0] : '-') + ' EUR</td></tr>';
                html += '<tr><td>Exchange Rate</td><td>' + resp.rate_eur_pln + '</td></tr>';
            } else {
                html += '<tr><td><strong>Price</strong></td><td>' + (resp.prediction ? resp.prediction[0] : '-') + ' ' + resp.currency + '</td></tr>';
            }
            html += '</table>';
            html += '</div>';

            // 2. Route Details
            html += '<div class="debug-section">';
            html += '<span class="debug-title">Route Details</span>';
            html += '<table class="debug-table">';
            html += '<tr><td>Distance</td><td>' + (payload.distance / 1000).toFixed(1) + ' km</td></tr>';
            if (payload.spots && payload.spots.length >= 2) {
                var origin = payload.spots[0].place;
                var dest = payload.spots[1].place;
                html += '<tr><td>Origin</td><td>' + origin.address.locality + ' (' + origin.address.postal_code + ') [' + origin.coordinates.latitude + ', ' + origin.coordinates.longitude + ']</td></tr>';
                html += '<tr><td>Destination</td><td>' + dest.address.locality + ' (' + dest.address.postal_code + ') [' + dest.coordinates.latitude + ', ' + dest.coordinates.longitude + ']</td></tr>';
            }
            html += '</table>';
            html += '</div>';

            // 3. Vehicle & Load
            html += '<div class="debug-section">';
            html += '<span class="debug-title">Vehicle & Load</span>';
            html += '<table class="debug-table">';
            var vr = payload.vehicle_requirements;
            html += '<tr><td>Vehicle Size</td><td>' + vr.vehicle_size_id + '</td></tr>';
            html += '<tr><td>Body</td><td>' + (vr.required_truck_bodies ? vr.required_truck_bodies.join(', ') : '-') + '</td></tr>';
            html += '<tr><td>Freight Type</td><td>' + vr.transport_type + '</td></tr>';
            html += '<tr><td>Capacity</td><td>' + vr.capacity + ' Tons</td></tr>';
            html += '<tr><td>Total LDM</td><td>' + payload.length + '</td></tr>';
            html += '</table>';
            html += '</div>';

            // 4. Raw JSONs (Collapsible)
            html += '<div class="debug-section">';
            html += '<span class="debug-title">Raw Data</span>';

            html += '<div><span class="json-toggle" onclick="jQuery(this).next().toggle()">Show Request Payload</span>';
            html += '<div class="json-content"><pre>' + JSON.stringify(payload, null, 2) + '</pre></div></div>';

            html += '<div style="margin-top:5px;"><span class="json-toggle" onclick="jQuery(this).next().toggle()">Show API Response</span>';
            html += '<div class="json-content"><pre>' + JSON.stringify(resp, null, 2) + '</pre></div></div>';

            html += '</div>';

            return html;
        }

        // Price Prediction Logic
        $('#predict_price_btn').click(function() {
            var form = $('#api_test_form');
            var resultContainer = $('#api_result_container');
            var resultContent = $('#api_result_content');
            var statusMsg = $('#api_status_msg');
            var manualToken = $('#manual_token_input').val();
            var data = form.serialize();
            if (manualToken) { data += '&token=' + encodeURIComponent(manualToken); }

            resultContainer.hide();
            statusMsg.html('<span style="color: blue;">Sending request...</span>');

            $.ajax({
                url: '<?= $block->getUrl('gardenlawn_transeu/test/predictPrice') ?>',
                type: 'POST',
                data: data + '&form_key=' + FORM_KEY,
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        statusMsg.html('<span style="color: green;">SUCCESS</span>');

                        var html = formatApiResult(response);
                        resultContent.html(html);

                        resultContainer.find('.result-box').removeClass('result-error').addClass('result-success');
                    } else {
                        statusMsg.html('<span style="color: red;">FAILED: ' + response.message + '</span>');
                        resultContent.html('<pre>' + JSON.stringify(response, null, 4) + '</pre>');
                        resultContainer.find('.result-box').removeClass('result-success').addClass('result-error');
                    }
                    resultContainer.slideDown();
                },
                error: function() { statusMsg.html('<span style="color: red;">Connection Error</span>'); }
            });
        });

        // Freights List Logic
        $('#get_freights_btn').click(function() {
            var resultContainer = $('#freights_result_container');
            var resultPre = $('#freights_result_pre');
            // Removed manual token logic for Freights List
            var data = 'form_key=' + FORM_KEY;

            resultContainer.hide();

            $.ajax({
                url: '<?= $block->getUrl('gardenlawn_transeu/test/freightsList') ?>',
                type: 'POST',
                data: data,
                dataType: 'json',
                success: function(response) {
                    resultPre.text(JSON.stringify(response.response, null, 4));
                    resultContainer.find('.result-box').removeClass('result-error').addClass('result-success');
                    resultContainer.slideDown();
                },
                error: function() {
                    resultPre.text('Connection Error');
                    resultContainer.find('.result-box').removeClass('result-success').addClass('result-error');
                    resultContainer.slideDown();
                }
            });
        });
    });
</script>
